<!DOCTYPE html>
<html>
<head>
    <title>d3-geo-zoom Controls Example</title>
    <style>
        body { 
            margin: 0;
            overflow: hidden;
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #1a1a1a 0%, #2c2c2c 100%);
        }
        .sphere {
            fill: #1a1f35;
        }
        .land {
            fill: #2a1b3d;
            stroke: #ff69b4;
            stroke-width: 0.5;
            filter: url(#glow);
        }
        .land:hover {
            fill: #3d2656;
        }
        #map-container {
            position: relative;
            width: 100vw;
            height: 100vh;
        }
        .controls {
            position: absolute;
            top: 20px;
            left: 20px;
            background: white;
            padding: 10px;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        button {
            display: block;
            margin: 5px 0;
            padding: 8px 12px;
            border: none;
            border-radius: 4px;
            background: #007bff;
            color: white;
            cursor: pointer;
        }
        button:hover {
            background: #0056b3;
        }
        button.active {
            background: #28a745;
        }
        button.active:hover {
            background: #218838;
        }
    </style>
</head>
<body>
    <div id="map-container">
        <div class="controls">
            <button id="zoomIn">Zoom In</button>
            <button id="zoomOut">Zoom Out</button>
            <button id="rotateUp">Rotate Up</button>
            <button id="rotateDown">Rotate Down</button>
            <button id="toggleNorth">North Up</button>
            <button id="toggleProjection">Toggle Projection</button>
        </div>
    </div>

    <script type="module">
        import * as d3 from 'https://cdn.jsdelivr.net/npm/d3@7/+esm';
        import { geoZoom } from '../../dist/@fxi/d3-geo-zoom.esm.js';
        import { feature } from 'https://cdn.jsdelivr.net/npm/topojson-client@3/+esm';

        const MARGIN = 5;
        const width = window.innerWidth;
        const height = window.innerHeight;

        const svg = d3.select('#map-container')
            .append('svg')
            .attr('width', width)
            .attr('height', height);

        // Add glow filter
        const defs = svg.append('defs');
        const filter = defs.append('filter')
            .attr('id', 'glow');

        filter.append('feGaussianBlur')
            .attr('stdDeviation', '2')
            .attr('result', 'coloredBlur');

        const feMerge = filter.append('feMerge');
        feMerge.append('feMergeNode')
            .attr('in', 'coloredBlur');
        feMerge.append('feMergeNode')
            .attr('in', 'SourceGraphic');

        // Create both projections
        const projections = {
            orthographic: d3.geoOrthographic()
                .scale((Math.min(width, height)) / 2 - MARGIN)
                .translate([width / 2, height / 2]),
            mercator: d3.geoTransverseMercator()
                .scale((Math.min(width, height)) / 2)
                .translate([width / 2, height / 2])
        };

        let currentProjection = projections.orthographic;
        const path = d3.geoPath()
            .projection(currentProjection);

        let zoomInstance = geoZoom()
            .projection(currentProjection)
            .onMove(render)
            (svg.node());

        function smoothTransition(callback) {
            svg.selectAll('path')
                .transition()
                .duration(750)
                .attrTween('d', function(d) {
                    const previous = d3.select(this).attr('d');
                    return function(t) {
                        callback(t);
                        return path(d);
                    };
                });
        }

        // Add sphere and land paths
        svg.append('path')
            .attr('class', 'sphere')
            .datum({ type: 'Sphere' });

        const world = svg.append('path')
            .attr('class', 'land');

        // Load world map data
        fetch('https://unpkg.com/world-atlas@1/world/110m.json')
            .then(response => response.json())
            .then(data => {
                world.datum(feature(data, data.objects.land));
                render();
            });

        // Immediate render without transition (for direct interactions)
        function render() {
            svg.selectAll('path').attr('d', path);
        }

        // Smooth render with transition (for button clicks)
        function renderWithTransition() {
            svg.selectAll('path')
                .transition()
                .duration(750)
                .attr('d', path);
        }

        // Control buttons functionality
        document.getElementById('zoomIn').onclick = () => {
            const scale = currentProjection.scale();
            currentProjection.scale(scale * 1.5);
            renderWithTransition();
        };
        
        document.getElementById('zoomOut').onclick = () => {
            const scale = currentProjection.scale();
            currentProjection.scale(scale / 1.5);
            renderWithTransition();
        };
        
        document.getElementById('rotateUp').onclick = () => {
            const [x, y, z] = currentProjection.rotate();
            smoothTransition(t => {
                currentProjection.rotate([x, y - (20 * t), z]);
            });
        };
        
        document.getElementById('rotateDown').onclick = () => {
            const [x, y, z] = currentProjection.rotate();
            smoothTransition(t => {
                currentProjection.rotate([x, y + (20 * t), z]);
            });
        };
        
        let northUp = false;
        const toggleNorthBtn = document.getElementById('toggleNorth');
        
        toggleNorthBtn.onclick = () => {
            northUp = !northUp;
            zoomInstance.northUp(northUp);
            toggleNorthBtn.classList.toggle('active', northUp);
            
            if (northUp) {
                // When enabling north up, smoothly transition to north
                const [x, y, z] = currentProjection.rotate();
                smoothTransition(t => {
                    currentProjection.rotate([
                        x * (1 - t), // Longitude to 0
                        y * (1 - t), // Latitude to 0
                        0           // Roll to 0
                    ]);
                });
            }
        };

        let isOrthographic = true;
        document.getElementById('toggleProjection').onclick = () => {
            const oldProjection = currentProjection;
            const [oldX, oldY, oldZ] = oldProjection.rotate();
            
            isOrthographic = !isOrthographic;
            currentProjection = isOrthographic ? projections.orthographic : projections.mercator;
            
            // Update path generator with new projection
            path.projection(currentProjection);
            
            // Keep the rotation state when possible
            if (currentProjection.rotate) {
                currentProjection.rotate([oldX, oldY, oldZ]);
            }
            
            // Update zoom instance with new projection
            zoomInstance = geoZoom()
                .projection(currentProjection)
                .onMove(render) // Use immediate render for direct interactions
                (svg.node());
            
            renderWithTransition(); // Use transition for projection toggle
        };
    </script>
</body>
</html>
