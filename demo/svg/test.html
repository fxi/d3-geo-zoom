<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>D3 Geo Zoom Test Utils</title>
  <style>
    body { 
      margin: 20px;
      font-family: sans-serif;
      background: #f0f0f0;
    }
    .controls {
      position: fixed;
      top: 20px;
      right: 20px;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .map {
      width: 600px;
      height: 600px;
      background: linear-gradient(135deg, #1a1a1a 0%, #2c2c2c 100%);
      border-radius: 8px;
    }
    button {
      display: block;
      margin: 5px 0;
      padding: 8px 16px;
      background: #4CAF50;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    button:hover {
      background: #45a049;
    }
    .sphere {
      fill: #1a1f35;
    }
    .land {
      fill: #2a1b3d;
      stroke: #ff69b4;
      stroke-width: 0.5;
      filter: url(#glow);
    }
  </style>
</head>
<body>
  <div class="map" id="world"></div>
  <div class="controls">
    <h3>Test Controls</h3>
    <button onclick="zoomTo([0, 0], 2)">Zoom to Center (2x)</button>
    <button onclick="zoomTo([0, 45], 3)">Zoom to 45°N (3x)</button>
    <button onclick="rotateTo([45, 0, 0])">Rotate to 45° East</button>
    <button onclick="rotateTo([-45, 45, 0])">Rotate to Pacific</button>
    <button onclick="reset()">Reset View</button>
  </div>

  <script type="module">
    import { geoZoom } from '/dist/@fxi/d3-geo-zoom.esm.js';
    import * as d3 from 'd3';
    import { feature } from 'topojson-client';

    // Initialize map
    const width = 600;
    const height = 600;
    const MARGIN = 5;

    const svg = d3.select('#world').append('svg')
      .attr('width', width)
      .attr('height', height);

    // Add glow filter
    const defs = svg.append('defs');
    const filter = defs.append('filter')
      .attr('id', 'glow');

    filter.append('feGaussianBlur')
      .attr('stdDeviation', '2')
      .attr('result', 'coloredBlur');

    const feMerge = filter.append('feMerge');
    feMerge.append('feMergeNode')
      .attr('in', 'coloredBlur');
    feMerge.append('feMergeNode')
      .attr('in', 'SourceGraphic');

    const projection = d3.geoOrthographic()
      .scale((Math.min(width, height)) / 2 - MARGIN)
      .translate([width / 2, height / 2]);

    const path = d3.geoPath()
      .projection(projection);

    // Initialize zoom behavior
    const zoom = geoZoom()
      .projection(projection)
      .onMove(render)
      .northUp(true);

    // Apply zoom behavior
    svg.call(zoom);

    // Load and render world data
    fetch('https://unpkg.com/world-atlas@1/world/110m.json')
      .then(response => response.json())
      .then(world => {
        svg.append('path')
          .attr('class', 'sphere')
          .datum({ type: 'Sphere' });

        svg.append('path')
          .attr('class', 'land')
          .datum(feature(world, world.objects.land));

        render();
      });

    function render() {
      svg.selectAll('path').attr('d', path);
    }

    // Test utility functions
    window.zoomTo = function(center, scale) {
      const baseScale = (Math.min(width, height)) / 2 - MARGIN;
      projection
        .scale(baseScale * scale)
        .rotate([0, 0, 0]);
      render();
    };

    window.rotateTo = function(rotation) {
      projection.rotate(rotation);
      render();
    };

    window.reset = function() {
      const baseScale = (Math.min(width, height)) / 2 - MARGIN;
      projection
        .scale(baseScale)
        .rotate([0, 0, 0]);
      render();
    };
  </script>
</body>
</html>
